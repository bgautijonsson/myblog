{
  "hash": "a6cbd5bf4aff8faee5a1fbbfcc7ddac7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Applying a Gaussian AR(1) Copula to Generalized Extreme Value Margins\"\nsubtitle: \"A simulation study of the differences between AR(1) copula and i.i.d copula\"\ndescription: |\n  Another step in my PhD studies is to apply multivariate copulas to data with Generalized Extreme Value marginal distributions. This is important to enable us to model dependence on the data leve, as opposed to the latent *(parameter)* level. \nauthor: \n    -   name: \"Brynjólfur Gauti Guðrúnar Jónsson\"\n        url: \"bggj.is\"\n        affiliation: \"Tölfræði, Raunvísindadeild Háskóla Íslands\"\n        affiliation-url: \"https://www.hi.is/tolfraedi_0\"\ndate: \"2024/02/06\"\nbibliography: references.bib\ndraft: false\nformat: \n    html:\n        code-fold: show\n        toc: true\n        toc-location: left\nexecute: \n  echo: true\n  warning: false\neditor: source\nimage: https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/elppd.png\ncategories:\n    - english\n    - R\n    - phd\n    - stan\n    - bayesian\n    - spatial statistics\n    - copulas\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gt)\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(bggjphd)\ntheme_set(theme_bggj())\n```\n:::\n\n\n\n# Introduction\n\n[In a previous post, I wrote about applying the BYM2 model to spatially dependent Generalized Extreme Value (GEV) data](https://bggj.is/posts/icar_gev/) and mentioned in passing that I was working on applying copulas as well. In this post I will outline and show results from a simulation study I've been running where I:\n\n* Learn how to generate multivariate data that have GEV margins and dependence structures based on an AR(1) Gaussian copula\n* Learn how to code simple Gaussian copulas in Stan\n* Compare the model fits of the AR(1) copula to a model where I assume i.i.d. observations\n\n## Copulas\n\nIn the book *Elements of Copula Modeling with R*, @hofertElementsCopulaModeling2018 define a copula as\n\n> a multivariate distribution function with standard uniform univariate margins, that is, U(0, 1) margins.\n\nSo, a Copula is any multivariate distribution whose margins is U(0,1 ) distributed. A simple example is the *independence copula*\n\n$$\n\\Pi(u) = \\prod_{j=1}^{d}{u_j}, \\quad \\mathbf U \\in [0, 1]^d.\n$$\n\nThe central theorem of copula theory is Sklar's theorem [@sklarRandomVariablesDistribution1996] *[the original paper is from 1959]*. The theorem basically states that for any d-dimensional distribution function, $H$, with univariate margins $F_1, \\dots, F_d$, there exists a d-dimensional copula $C$ such that\n\n$$\nH(\\mathbf x) = C(F_1(x_1), \\dots, F_d(x_d)).\n$$\n\nAlternatively, we can write\n\n$$\nC(\\mathbf u) = H(F_1^{-1}(u_1), \\dots, F_d^{-1}(u_d))\n$$\n\n### Gaussian Copula\n\nThe Gaussian family of copulas can be written\n\n$$\nC(\\mathbf u | R) = \\Phi_d\\left(\\Phi^{-1}(u_1), \\dots, \\Phi^{-1}(u_d) \\vert R \\right), \\quad \\mathbf u \\in [0, 1]^d,\n$$\n\nwhere R is a $d\\times d$ correlation matrix, $\\Phi_d$ is the CDF of a d-dimensional multivariate Gaussian with mean $\\mathbf 0$ and covariance matrix $R$, and $\\Phi$ is the CDF of a standard Gaussian.\n\nIts density is\n\n$$\nc(\\mathbf u \\vert R) = \\frac{\\phi_d\\left(\\Phi^{-1}(u_1), \\dots, \\Phi^{-1}(u_d) \\vert R \\right)}{ \\prod_{j=1}^{d}{\\phi\\left( \\Phi^{-1}(u_j) \\right)}}, \\quad \\mathbf u \\in [0, 1]^d,\n$$\n\nwhere $\\phi_d$ is the density of the same multivariate Gaussian, and $\\phi$ is the density of a standard gaussian.\n\n#### Sampling from the Gaussian copula\n\nGiven the $d\\times d$ correlation matrix, $R$:\n\n1. Compute the Cholesky factor $L$ of the correlation matrix, $R$.\n2. Sample $Z_1, \\dots, Z_d \\overset{iid}{\\sim}\\mathrm{Normal}(0, 1)$.\n3. Compute $X = LZ$.\n4. Return $\\mathbf u = \\left(\\Phi(X_1), \\dots, \\Phi(X_d)\\right)$\n\nWe can then make the margins $u_1, \\dots, u_d$ follow any distribution *(f.ex. the GEV distribution)* by applying its quantile function.\n\n### Example\n\nLet's sample from a two-dimensional process with GEV(8, 2, 0.05) margins and a Gaussian copula with correlation $\\rho = 0.7$.\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code  code-fold=\"true\"}\nR <- matrix(c(1, 0.7, 0.7, 1), nrow = 2)\nset.seed(1)\nX <- mvtnorm::rmvnorm(\n  n = 200,\n  sigma = R\n)\n\nX |> \n  as_tibble() |> \n  mutate(\n    id = row_number()\n  ) |> \n  pivot_longer(c(-id), names_to = \"variable\", values_to = \"Z\") |> \n  mutate(\n    U = pnorm(Z),\n    Y = evd::qgev(U, loc = 8, scale = 2, shape = 0.05)\n  ) |> \n  pivot_longer(c(-id, -variable)) |> \n  pivot_wider(names_from = variable, values_from = value) |>\n  mutate(\n    name = fct_relevel(name, \"Z\", \"U\", \"Y\") |> \n      fct_recode(\n        \"Z (Gaussian)\" = \"Z\",\n        \"U (Uniform)\" = \"U\",\n        \"Y (GEV)\" = \"Y\"\n      )\n  ) |> \n  group_by(name2 = name) |> \n  group_map(\n    function(data, ...) {\n      data |> \n        ggplot(aes(V1, V2)) +\n        geom_density_2d_filled() +\n        geom_point(col = \"grey70\") +\n        coord_cartesian(expand = FALSE) +\n        theme(legend.position = \"none\") +\n        labs(\n          x = NULL,\n          y = NULL,\n          subtitle = data$name\n        )\n    }\n  ) |> \n  wrap_plots() +\n  plot_annotation(\n    title = \"The stages in generating 2d GEV(8, 2, 0.05) data with a Gaussian correlation 0.7\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=100%}\n:::\n:::\n\n\n\n# Methods\n\n## Data\n\n[R scripts used for simulating the data](https://github.com/bgautijonsson/stan_experiments/blob/master/R/data.R)\n\nThe simulated data have GEV margins and an AR(1) Gaussian copula. The steps in simulating the data are as follows.\n\n1. Generate a correlation matrix, R, based on an AR(1) process\n2. Generate multivariate normal variates with mean zero and covariance matrix R.\n3. Transform to GEV by applying normal CDF and GEV quantile functions\n\n### 1. Correlation Matrix\n\nFirst, a correlation matrix is generated that encodes an AR(1) process with correlation $\\rho$. To create this correlation matrix, we specify the precision matrix, $Q$, via\n\n$$\nQ = \\frac{1}{1 - \\rho^2}\\begin{bmatrix}\n1 & -\\rho & \\dots & \\dots & \\vdots\\\\\n-\\rho & 1 + \\rho^2 & -\\rho & \\ddots & \\vdots \\\\\n\\vdots & \\ddots & \\ddots & \\ddots & \\vdots \\\\ \n\\vdots & \\ddots &-\\rho & 1 + \\rho^2 & -\\rho \\\\\n\\vdots & \\dots & \\dots & -\\rho & 1 \n\\end{bmatrix}.\n$$\n\nThis gives us the correlation matrix, R, where\n\n$$\nR = Q^{-1} = \\begin{bmatrix}\n1 & \\rho & \\rho^2 & \\dots & \\rho^n\\\\\n\\rho & 1 & \\rho & \\ddots & \\rho^{n-1} \\\\\n\\vdots & \\ddots & \\ddots & \\ddots & \\vdots \\\\ \n\\rho^{n-1} & \\ddots &\\rho & 1 & \\rho \\\\\n\\rho^n & \\dots & \\dots & \\rho & 1 \n\\end{bmatrix}.\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_AR_cor_matrix_1d <- function(n_id, rho = 0.5) {\n  P <- matrix(\n    0, \n    nrow = n_id,\n    ncol = n_id\n  )\n  diag(P) <- 1\n  for (i in seq(1, n_id - 1)) {\n    P[i, i + 1] <- -rho\n  }\n  \n  for (i in seq(2, n_id)) {\n    P[i, i - 1] <- -rho\n  }\n  \n  for (i in seq(2, n_id - 1)) {\n    P[i, i] <- 1 + rho^2\n  }\n  \n  P <- P / (1 - rho^2)\n  \n  P_cor <- solve(P)\n  P_cor\n}\n\nn_id <- 5\nrho <- 0.5\n\nR <- make_AR_cor_matrix_1d(n_id = n_id, rho = rho)\nR\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       [,1]  [,2] [,3]  [,4]   [,5]\n[1,] 1.0000 0.500 0.25 0.125 0.0625\n[2,] 0.5000 1.000 0.50 0.250 0.1250\n[3,] 0.2500 0.500 1.00 0.500 0.2500\n[4,] 0.1250 0.250 0.50 1.000 0.5000\n[5,] 0.0625 0.125 0.25 0.500 1.0000\n```\n\n\n:::\n:::\n\n\n\n### 2. Generating Multivariate Normal Data\n\nWe then use the well-known fact that if \n\n$$\n\\mathbf X \\sim \\mathrm{MVNorm}\\left(\\boldsymbol \\mu, \\Sigma\\right),\n$$\n\nthen\n\n$$\n\\boldsymbol X = \\boldsymbol \\mu +  L \\boldsymbol Z,\n$$\n\nwhere $\\boldsymbol Z \\sim \\mathrm{Normal}(\\boldsymbol 0,  I)$ and $L$ is the Cholesky decomposition of $R$, or $LL^T = \\Sigma$. \n\nIn our case, we want $\\mathbf X$ to have mean 0 and covariance matrix $R$, so we write\n\n$$\n\\mathbf X = L\\mathbf Z\n$$\n\nwhere $LL^T = R$.\n\nWe can skip the manual Cholesky factorization and simply use the `{mvtnorm}` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsample_gaussian_variables <- function(cor_matrix, n_replicates) {\n  mvtnorm::rmvnorm(\n    n = n_replicates,\n    sigma = cor_matrix\n  )\n}\n\nR |> \n  sample_gaussian_variables(n_replicates = 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         [,1]     [,2]       [,3]       [,4]       [,5]\n[1,] 1.427875 1.837133 -0.1348893 -0.3970323 -0.4613493\n```\n\n\n:::\n:::\n\n\nWe will want more than one observation from each *\"site\"*, so we write a helped function for tidying this output into a tibble.\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ntidy_mvgauss <- function(mvnorm_matrix) {\n  colnames(mvnorm_matrix) <- seq_len(ncol(mvnorm_matrix))\n  \n  mvnorm_matrix |> \n    dplyr::as_tibble() |> \n    dplyr::mutate(\n      replicate = dplyr::row_number(),\n      .before = `1`\n    ) |> \n    tidyr::pivot_longer(\n      c(-replicate),\n      names_to = \"id\", names_transform = as.numeric,\n      values_to = \"Z\"\n    )\n  \n}\n\nn_replicates <- 10\nmvnorm_data <- R |> \n  sample_gaussian_variables(n_replicates = n_replicates) |> \n  tidy_mvgauss()\n\nmvnorm_data |> \n  filter(replicate <= 5) |> \n  pivot_wider(names_from = replicate, values_from = Z) |> \n  gt() |> \n  tab_spanner(\n    columns = -id,\n    label = \"Replicate\"\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"allyryhvel\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#allyryhvel table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#allyryhvel thead, #allyryhvel tbody, #allyryhvel tfoot, #allyryhvel tr, #allyryhvel td, #allyryhvel th {\n  border-style: none;\n}\n\n#allyryhvel p {\n  margin: 0;\n  padding: 0;\n}\n\n#allyryhvel .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#allyryhvel .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#allyryhvel .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#allyryhvel .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#allyryhvel .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#allyryhvel .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#allyryhvel .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#allyryhvel .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#allyryhvel .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#allyryhvel .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#allyryhvel .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#allyryhvel .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#allyryhvel .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#allyryhvel .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#allyryhvel .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#allyryhvel .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#allyryhvel .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#allyryhvel .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#allyryhvel .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#allyryhvel .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#allyryhvel .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#allyryhvel .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#allyryhvel .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#allyryhvel .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#allyryhvel .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#allyryhvel .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#allyryhvel .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#allyryhvel .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#allyryhvel .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#allyryhvel .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#allyryhvel .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#allyryhvel .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#allyryhvel .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#allyryhvel .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#allyryhvel .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#allyryhvel .gt_left {\n  text-align: left;\n}\n\n#allyryhvel .gt_center {\n  text-align: center;\n}\n\n#allyryhvel .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#allyryhvel .gt_font_normal {\n  font-weight: normal;\n}\n\n#allyryhvel .gt_font_bold {\n  font-weight: bold;\n}\n\n#allyryhvel .gt_font_italic {\n  font-style: italic;\n}\n\n#allyryhvel .gt_super {\n  font-size: 65%;\n}\n\n#allyryhvel .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#allyryhvel .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#allyryhvel .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#allyryhvel .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#allyryhvel .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#allyryhvel .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#allyryhvel .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings gt_spanner_row\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"2\" colspan=\"1\" scope=\"col\" id=\"id\">id</th>\n      <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"5\" scope=\"colgroup\" id=\"Replicate\">\n        <span class=\"gt_column_spanner\">Replicate</span>\n      </th>\n    </tr>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"1\">1</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"2\">2</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"3\">3</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"4\">4</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"5\">5</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">1</td>\n<td headers=\"1\" class=\"gt_row gt_right\">-0.4364007</td>\n<td headers=\"2\" class=\"gt_row gt_right\">-0.1443106</td>\n<td headers=\"3\" class=\"gt_row gt_right\">0.7080631</td>\n<td headers=\"4\" class=\"gt_row gt_right\">1.1388723</td>\n<td headers=\"5\" class=\"gt_row gt_right\">1.0330390</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">2</td>\n<td headers=\"1\" class=\"gt_row gt_right\">-0.4017539</td>\n<td headers=\"2\" class=\"gt_row gt_right\">0.6923541</td>\n<td headers=\"3\" class=\"gt_row gt_right\">0.9544816</td>\n<td headers=\"4\" class=\"gt_row gt_right\">-0.4595604</td>\n<td headers=\"5\" class=\"gt_row gt_right\">-1.3986486</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">3</td>\n<td headers=\"1\" class=\"gt_row gt_right\">-0.1161437</td>\n<td headers=\"2\" class=\"gt_row gt_right\">0.9328314</td>\n<td headers=\"3\" class=\"gt_row gt_right\">-0.1228664</td>\n<td headers=\"4\" class=\"gt_row gt_right\">-0.4689164</td>\n<td headers=\"5\" class=\"gt_row gt_right\">-1.1884398</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">4</td>\n<td headers=\"1\" class=\"gt_row gt_right\">1.0500406</td>\n<td headers=\"2\" class=\"gt_row gt_right\">-0.5297770</td>\n<td headers=\"3\" class=\"gt_row gt_right\">-0.8530328</td>\n<td headers=\"4\" class=\"gt_row gt_right\">-1.5227378</td>\n<td headers=\"5\" class=\"gt_row gt_right\">-1.0434809</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_right\">5</td>\n<td headers=\"1\" class=\"gt_row gt_right\">-0.3607882</td>\n<td headers=\"2\" class=\"gt_row gt_right\">-0.5568922</td>\n<td headers=\"3\" class=\"gt_row gt_right\">1.3144552</td>\n<td headers=\"4\" class=\"gt_row gt_right\">0.1006016</td>\n<td headers=\"5\" class=\"gt_row gt_right\">-0.9255078</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n### 3. Transforming to Multivariate GEV\n\nNow our data, $\\mathbf X$, is multivariate normal with dependence structure according to an AR(1) process, but marginally each $X_1$ is standard normal. To transform this data to a GEV dataset, we simply use the standard normal CDF on each $X_i$ to transform it to $[0, 1]$, then we use the GEV quantile function to transform that to a GEV distributed variable.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmvnorm_to_gev <- function(mvnorm_data, gev_params) {\n  \n  mvnorm_data |> \n    dplyr::mutate(\n      U = pnorm(Z)\n    ) |> \n    dplyr::inner_join(\n      gev_params,\n      by = dplyr::join_by(id)\n    ) |> \n    dplyr::mutate(\n      y = purrr:::pmap_dbl(\n        list(U, mu, sigma, xi), \n        \\(U, mu, sigma, xi) evd::qgev(p = U, loc = mu, scale = sigma, shape = xi)\n      )\n    )\n}\n\ngev_params <- expand_grid(\n  mu = 6,\n  sigma = 3,\n  xi = 0.1,\n  id = seq_len(n_id)\n)\n\ngev_data <- mvnorm_data |> \n  mvnorm_to_gev(gev_params = gev_params)\n\ngev_data |> \n  select(-mu, -sigma, -xi) |> \n  gt() |> \n  opt_interactive()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"ibiiwikvyj\" class=\".gt_table\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#ibiiwikvyj table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#ibiiwikvyj thead, #ibiiwikvyj tbody, #ibiiwikvyj tfoot, #ibiiwikvyj tr, #ibiiwikvyj td, #ibiiwikvyj th {\n  border-style: none;\n}\n\n#ibiiwikvyj p {\n  margin: 0;\n  padding: 0;\n}\n\n#ibiiwikvyj .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#ibiiwikvyj .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ibiiwikvyj .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ibiiwikvyj .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ibiiwikvyj .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ibiiwikvyj .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ibiiwikvyj .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ibiiwikvyj .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ibiiwikvyj .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#ibiiwikvyj .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#ibiiwikvyj .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ibiiwikvyj .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ibiiwikvyj .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ibiiwikvyj .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ibiiwikvyj .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ibiiwikvyj .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#ibiiwikvyj .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#ibiiwikvyj .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#ibiiwikvyj .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ibiiwikvyj .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#ibiiwikvyj .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ibiiwikvyj .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ibiiwikvyj .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ibiiwikvyj .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ibiiwikvyj .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ibiiwikvyj .gt_left {\n  text-align: left;\n}\n\n#ibiiwikvyj .gt_center {\n  text-align: center;\n}\n\n#ibiiwikvyj .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ibiiwikvyj .gt_font_normal {\n  font-weight: normal;\n}\n\n#ibiiwikvyj .gt_font_bold {\n  font-weight: bold;\n}\n\n#ibiiwikvyj .gt_font_italic {\n  font-style: italic;\n}\n\n#ibiiwikvyj .gt_super {\n  font-size: 65%;\n}\n\n#ibiiwikvyj .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#ibiiwikvyj .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#ibiiwikvyj .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#ibiiwikvyj .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#ibiiwikvyj .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#ibiiwikvyj .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#ibiiwikvyj .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<div id=\"ibiiwikvyj\" class=\"reactable html-widget\" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"ibiiwikvyj\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"replicate\":[1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,9,10,10,10,10,10],\"id\":[1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5],\"Z\":[-0.436400693613395,-0.40175394594592,-0.116143721596351,1.05004059845307,-0.360788206156438,-0.14431056795981,0.692354091128984,0.932831442470785,-0.529776983043089,-0.556892197284997,0.708063052719815,0.954481648015603,-0.122866398581155,-0.853032844402126,1.31445524907948,1.13887233483044,-0.459560365435904,-0.46891641177034,-1.52273778348423,0.100601628655834,1.03303903081493,-1.39864863141536,-1.18843981440738,-1.0434808918175,-0.925507829156898,-1.96758543411807,-0.389680366650337,-1.44549204520968,-0.279949058460535,0.404262580468665,0.0151424413945846,0.741794253764442,0.0774260679875857,-0.374394318778974,0.490011288131499,0.0601685473789478,1.62662223016871,0.596463717372009,0.988054788236387,0.470944393469519,-3.30891201940578,-2.19744819898392,-1.1720201021629,-0.710983425933536,-2.34337404028904,0.617117182031725,-0.70636855922379,-1.26914749602017,-2.01289999093559,-1.86586139463375],\"U\":[0.331273017904217,0.343932559331943,0.453769319217614,0.853150276284483,0.35912888998128,0.442627616817266,0.755642505580172,0.824546497908587,0.298133282743833,0.288800543015228,0.760546948709157,0.830080052755613,0.451106447011626,0.196820545275446,0.905653475825307,0.872621796995532,0.32291590677713,0.31956469244988,0.0639121605429595,0.540066648106347,0.849207183251212,0.0809591876884787,0.117330089153576,0.148362813070752,0.177350906561091,0.0245578785184396,0.348386458126261,0.0741598629020429,0.389758294078632,0.65699018046656,0.506040729249895,0.770893998683139,0.530857698115674,0.354055484540542,0.687937044452128,0.523989302065766,0.948091322501727,0.724567257329202,0.838437091765541,0.681159777571263,0.000468296318753365,0.0139942260925248,0.120594492758036,0.23854725324225,0.00955510690337406,0.731421281828687,0.239979483971628,0.102194231511664,0.0220625757682728,0.0310303800100331],\"y\":[5.70245865937722,5.80521160639786,6.7149210552835,12.0604259428969,5.92871865464969,6.61992228224846,10.0703404666316,11.365771528482,5.43303281782684,5.35678086577758,10.150023630469,11.4907812604924,6.69213600827318,4.57745492985712,13.8019789993175,12.6173267039677,5.63462584030404,5.60741376720909,3.11340781612174,7.48899221155845,11.9568970649056,3.35823072972186,3.79865730844483,4.12297528940259,4.40050481731709,2.31614354228411,5.84138308427152,3.26454999825161,6.17905464999368,8.71805005790837,7.17437362094691,10.3233596531161,7.40240866546277,5.88745261904053,9.09995213342542,7.33855110379731,16.2202632087269,9.59783586842642,11.6875544779455,9.0135965690878,0.471582488369624,1.94702173110692,3.83451209489253,4.9394946185385,1.7258429156592,9.69762911942427,4.95160967177567,3.62555489427281,2.24125717823303,2.48825938515974]},\"columns\":[{\"id\":\"replicate\",\"name\":\"replicate\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"1\",\"1\",\"1\",\"1\",\"2\",\"2\",\"2\",\"2\",\"2\",\"3\",\"3\",\"3\",\"3\",\"3\",\"4\",\"4\",\"4\",\"4\",\"4\",\"5\",\"5\",\"5\",\"5\",\"5\",\"6\",\"6\",\"6\",\"6\",\"6\",\"7\",\"7\",\"7\",\"7\",\"7\",\"8\",\"8\",\"8\",\"8\",\"8\",\"9\",\"9\",\"9\",\"9\",\"9\",\"10\",\"10\",\"10\",\"10\",\"10\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"id\",\"name\":\"id\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\",\"1\",\"2\",\"3\",\"4\",\"5\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"Z\",\"name\":\"Z\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"-0.43640069\",\"-0.40175395\",\"-0.11614372\",\"1.05004060\",\"-0.36078821\",\"-0.14431057\",\"0.69235409\",\"0.93283144\",\"-0.52977698\",\"-0.55689220\",\"0.70806305\",\"0.95448165\",\"-0.12286640\",\"-0.85303284\",\"1.31445525\",\"1.13887233\",\"-0.45956037\",\"-0.46891641\",\"-1.52273778\",\"0.10060163\",\"1.03303903\",\"-1.39864863\",\"-1.18843981\",\"-1.04348089\",\"-0.92550783\",\"-1.96758543\",\"-0.38968037\",\"-1.44549205\",\"-0.27994906\",\"0.40426258\",\"0.01514244\",\"0.74179425\",\"0.07742607\",\"-0.37439432\",\"0.49001129\",\"0.06016855\",\"1.62662223\",\"0.59646372\",\"0.98805479\",\"0.47094439\",\"-3.30891202\",\"-2.19744820\",\"-1.17202010\",\"-0.71098343\",\"-2.34337404\",\"0.61711718\",\"-0.70636856\",\"-1.26914750\",\"-2.01289999\",\"-1.86586139\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"U\",\"name\":\"U\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"0.3312730179\",\"0.3439325593\",\"0.4537693192\",\"0.8531502763\",\"0.3591288900\",\"0.4426276168\",\"0.7556425056\",\"0.8245464979\",\"0.2981332827\",\"0.2888005430\",\"0.7605469487\",\"0.8300800528\",\"0.4511064470\",\"0.1968205453\",\"0.9056534758\",\"0.8726217970\",\"0.3229159068\",\"0.3195646924\",\"0.0639121605\",\"0.5400666481\",\"0.8492071833\",\"0.0809591877\",\"0.1173300892\",\"0.1483628131\",\"0.1773509066\",\"0.0245578785\",\"0.3483864581\",\"0.0741598629\",\"0.3897582941\",\"0.6569901805\",\"0.5060407292\",\"0.7708939987\",\"0.5308576981\",\"0.3540554845\",\"0.6879370445\",\"0.5239893021\",\"0.9480913225\",\"0.7245672573\",\"0.8384370918\",\"0.6811597776\",\"0.0004682963\",\"0.0139942261\",\"0.1205944928\",\"0.2385472532\",\"0.0095551069\",\"0.7314212818\",\"0.2399794840\",\"0.1021942315\",\"0.0220625758\",\"0.0310303800\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}},{\"id\":\"y\",\"name\":\"y\",\"type\":\"numeric\",\"style\":\"function(rowInfo, colInfo) {\\nconst rowIndex = rowInfo.index + 1\\n}\",\"cell\":[\"5.7024587\",\"5.8052116\",\"6.7149211\",\"12.0604259\",\"5.9287187\",\"6.6199223\",\"10.0703405\",\"11.3657715\",\"5.4330328\",\"5.3567809\",\"10.1500236\",\"11.4907813\",\"6.6921360\",\"4.5774549\",\"13.8019790\",\"12.6173267\",\"5.6346258\",\"5.6074138\",\"3.1134078\",\"7.4889922\",\"11.9568971\",\"3.3582307\",\"3.7986573\",\"4.1229753\",\"4.4005048\",\"2.3161435\",\"5.8413831\",\"3.2645500\",\"6.1790546\",\"8.7180501\",\"7.1743736\",\"10.3233597\",\"7.4024087\",\"5.8874526\",\"9.0999521\",\"7.3385511\",\"16.2202632\",\"9.5978359\",\"11.6875545\",\"9.0135966\",\"0.4715825\",\"1.9470217\",\"3.8345121\",\"4.9394946\",\"1.7258429\",\"9.6976291\",\"4.9516097\",\"3.6255549\",\"2.2412572\",\"2.4882594\"],\"html\":true,\"align\":\"right\",\"headerStyle\":{\"font-weight\":\"normal\"}}],\"defaultPageSize\":10,\"showPageSizeOptions\":false,\"pageSizeOptions\":[10,25,50,100],\"paginationType\":\"numbers\",\"showPagination\":true,\"showPageInfo\":true,\"minRows\":1,\"showSortable\":true,\"height\":\"auto\",\"theme\":{\"color\":\"#333333\",\"backgroundColor\":\"#FFFFFF\",\"stripedColor\":\"rgba(128,128,128,0.05)\",\"style\":{\"fontFamily\":\"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif\"},\"headerStyle\":{\"borderTopStyle\":\"solid\",\"borderTopWidth\":\"2px\",\"borderTopColor\":\"#D3D3D3\",\"borderBottomStyle\":\"solid\",\"borderBottomWidth\":\"2px\",\"borderBottomColor\":\"#D3D3D3\"}},\"elementId\":\"ibiiwikvyj\",\"dataKey\":\"35728e61f7c230d7f361bb3f930b6a6c\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[\"tag.attribs.columns.0.style\",\"tag.attribs.columns.1.style\",\"tag.attribs.columns.2.style\",\"tag.attribs.columns.3.style\",\"tag.attribs.columns.4.style\"],\"jsHooks\":[]}</script>\n</div>\n```\n\n:::\n:::\n\n\n## Checking the data\n\nLet's create a function that plots heat maps for each of the three representations of the data\n\n* Z: The multivariate normal\n* U: The multivariate uniform\n* y: The multivariate GEV\n\nWe want the color scales to be free, so we use `group_map()` and `wrap_plots()` instead of `facet_wrap()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- function(data) {\n  data |> \n    select(replicate, id, Z, U, y) |> \n    pivot_longer(c(-replicate, -id)) |> \n    mutate(\n      name = fct_relevel(name, \"Z\", \"U\", \"y\"),\n      name2 = name\n    ) |> \n    group_by(name) |> \n    group_map(\n      function(data, ...) {\n        data |> \n          ggplot(aes(id, replicate, fill = value)) +\n          geom_raster() +\n          scale_fill_viridis_c() +\n          coord_cartesian(expand = FALSE) +\n          theme(legend.position = \"none\") +\n          labs(\n            subtitle = data$name2\n          )\n      }\n    ) |> \n    wrap_plots() +\n    plot_layout(nrow = 1) +\n    plot_annotation(\n      title = \"Heatmaps of the three data representations\",\n      subtitle = \"Z: Normal | U: Uniform | y: GEV\"\n    )\n}\n```\n:::\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\ngev_data |> \n  plot_data()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=100%}\n:::\n:::\n\n\n\nIt's nice to wrap this process in a single function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_data <- function(gev_params, n_replicate, rho) {\n  \n  make_AR_cor_matrix_1d(n_id = nrow(gev_params), rho = rho) |> \n    sample_gaussian_variables(n_replicates = n_replicate) |> \n    tidy_mvgauss() |> \n    dplyr::mutate(\n      U = pnorm(Z)\n    ) |> \n    dplyr::inner_join(\n      gev_params,\n      by = dplyr::join_by(id)\n    ) |> \n    dplyr::mutate(\n      y = purrr::pmap_dbl(\n        list(U, mu, sigma, xi), \n        \\(U, mu, sigma, xi) evd::qgev(p = U, loc = mu, scale = sigma, shape = xi)\n      )\n    )\n}\n```\n:::\n\n\nLet's see how the data look if we make it larger and increase the correlation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn_id <- 40\nn_replicates <- 100\n\ngev_params <- expand_grid(\n  mu = 6,\n  sigma = 3,\n  xi = 0.1,\n  id = seq_len(n_id)\n)\n\nd <- make_data(gev_params, n_replicates, rho = 0.95)\n```\n:::\n\n\n\nWe see that with higher neighbor correlations we get obvious horizontal stripes corresponding to a large amount of dependence within each replicate.\n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\nd |> plot_data()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=100%}\n:::\n:::\n\n\n\n## Modeling\n\n[R scripts used for modeling](https://github.com/bgautijonsson/stan_experiments/blob/master/R/modeling.R)\n\n\n\n### AR(1) Model\n\nWe can fit the `AR(1)` model directly using Stan. \n\n\n::: {.cell .column-screen-right output.var='model_ar1'}\n\n```{.stan .cell-code}\nfunctions {\n  real normal_ar1_lpdf(vector x, real rho) {\n    int N = num_elements(x);\n    real out;\n    real log_det = - (N - 1) * (log(1 + rho) + log(1 - rho)) / 2;\n    vector[N] q;\n    real scl = sqrt(1 / (1 - rho^2));\n    \n    q[1:(N - 1)] = scl * (x[1:(N - 1)] - rho * x[2:N]);\n    q[N] = x[N];\n    \n    out = log_det - dot_self(q) / 2;\n    \n    return out;\n  }\n\n  real normal_copula_ar1_lpdf(vector U, real rho) {\n    int N = rows(U);\n    vector[N] Z = inv_Phi(U);\n    return normal_ar1_lpdf(Z | rho) + dot_self(Z) / 2;\n  }\n\n  real gev_cdf(real y, real mu, real sigma, real xi) {\n    if (abs(xi) < 1e-10) {\n      real z = (y - mu) / sigma;\n      return exp(-exp(z));\n    } else {\n      real z = 1 + xi * (y - mu) / sigma;\n      if (z > 0) {\n        return exp(-pow(z, -1/xi));\n      } else {\n        reject(\"Found incompatible GEV parameter values\");\n      }\n    }\n  } \n\n  real gev_lpdf(real y, real mu, real sigma, real xi) {\n    if (abs(xi) < 1e-10) {\n      real z = (y - mu) / sigma;\n      return -log(sigma) - z - exp(-z);\n    } else {\n      real z = 1 + xi * (y - mu) / sigma;\n      if (z > 0) {\n        return -log(sigma) - (1 + 1/xi) * log(z) - pow(z, -1/xi);\n      } else {\n        reject(\"Found incompatible GEV parameter values\");\n      }\n    }\n  }\n}\n\ndata {\n  int<lower = 0> n_replicate;\n  int<lower = 0> n_id;\n  array[n_replicate, n_id] real y;\n  array[n_replicate, n_id] real y_test;\n}\n\nparameters {\n  real<lower = 0> mu;\n  real<lower = 0> sigma;\n  real<lower = -0.5, upper = 1> xi;\n  real<lower = -1, upper = 1> rho;\n}\n\nmodel {\n  for (i in 1:n_replicate) {\n    vector[n_id] U;\n    for (j in 1:n_id) {    \n      U[j] = gev_cdf(y[i, j] | mu, sigma, xi);\n      target += gev_lpdf(y[i, j] | mu, sigma, xi);\n    } \n    target += normal_copula_ar1_lpdf(U | rho);\n  }\n}\n \ngenerated quantities {\n  real log_lik = 0;\n  {\n    \n    for (i in 1:n_replicate) {\n      vector[n_id] U;\n      for (j in 1:n_id) {\n        U[j] = gev_cdf(y_test[i, j] | mu, sigma, xi);\n        log_lik += gev_lpdf(y_test[i, j] | mu, sigma, xi);\n      }\n      log_lik += normal_copula_ar1_lpdf(U | rho);\n    }\n  }\n  \n}\n```\n:::\n\n\n### i.i.d. Model\n\n\n::: {.cell .column-screen-right output.var='model_iid'}\n\n```{.stan .cell-code}\nfunctions {\n  real gev_lpdf(real y, real mu, real sigma, real xi) {\n    if (abs(xi) < 1e-10) {\n      real z = (y - mu) / sigma;\n      return -log(sigma) - z - exp(-z);\n    } else {\n      real z = 1 + xi * (y - mu) / sigma;\n      if (z > 0) {\n        return -log(sigma) - (1 + 1/xi) * log(z) - pow(z, -1/xi);\n      } else {\n        reject(\"Found incompatible GEV parameter values\");\n      }\n    }\n  }\n}\n\ndata {\n  int<lower = 0> n_replicate;\n  int<lower = 0> n_id;\n  array[n_replicate, n_id] real y;\n  array[n_replicate, n_id] real y_test;\n}\n\nparameters {\n  real<lower = 0> mu;\n  real<lower = 0> sigma;\n  real<lower = -0.5, upper = 1> xi;\n}\n\ntransformed parameters {\n  \n}\n\nmodel {\n  for (i in 1:n_replicate) {\n    for (j in 1:n_id) {\n      target += gev_lpdf(y[i, j] | mu, sigma, xi);\n    }\n  }\n}\n\ngenerated quantities {\n  real log_lik = 0;\n  {\n    \n    for (i in 1:n_replicate) {\n      for (j in 1:n_id) {\n        log_lik += gev_lpdf(y_test[i, j] | mu, sigma, xi);\n      }\n    }\n  }\n}\n\n```\n:::\n\n\n### Two-Step Estimation\n\nWe can't fit this model directly using one stan file. What we do is:\n\n1. Estimate the marginal distributions\n2. Use the empirical CDFs to transform the data into uniformly distributed variables\n3. Transform these uniformly distributed variables into standard normal variables\n4. Estimate the precision matrix using these variables\n5. Make sure the precision matrix is semi-positive definite and normalize it so that its inverse is a correlation matrix\n6. Re-estimate the marginal distributions with a gaussian copula assuming this precision matrix is known\n\n\n::: {.cell .column-screen-right output.var='model_twostep'}\n\n```{.stan .cell-code}\nfunctions {\n  real gev_cdf(real y, real mu, real sigma, real xi) {\n    if (abs(xi) < 1e-10) {\n      real z = (y - mu) / sigma;\n      return exp(-exp(z));\n    } else {\n      real z = 1 + xi * (y - mu) / sigma;\n      if (z > 0) {\n        return exp(-pow(z, -1/xi));\n      } else {\n        reject(\"Found incompatible GEV parameter values\");\n      }\n    }\n  }\n\n  real gev_lpdf(real y, real mu, real sigma, real xi) {\n    if (abs(xi) < 1e-10) {\n      real z = (y - mu) / sigma;\n      return -log(sigma) - z - exp(-z);\n    } else {\n      real z = 1 + xi * (y - mu) / sigma;\n      if (z > 0) {\n        return -log(sigma) - (1 + 1/xi) * log(z) - pow(z, -1/xi);\n      } else {\n        reject(\"Found incompatible GEV parameter values\");\n      }\n    }\n  }\n\n  real normal_prec_chol_lpdf(vector x, array[] int n_values, array[] int index, vector values, real log_det) {\n    int N = num_elements(x);\n    int counter = 1;\n    vector[N] q = rep_vector(0, N);\n\n    for (i in 1:N) {\n      for (j in 1:n_values[i]) {\n        q[i] += values[counter] * x[index[counter]];\n        counter += 1;\n      }\n    }\n\n    return log_det - dot_self(q) / 2;\n\n  }\n\n  real normal_copula_prec_chol_lpdf(vector U, array[] int n_values, array[] int index, vector value, real log_det) {\n    int N = rows(U);\n    vector[N] Z = inv_Phi(U);\n\n    return normal_prec_chol_lpdf(Z | n_values, index, value, log_det) + dot_self(Z) / 2;\n  }\n\n}\n\ndata {\n  int<lower = 0> n_replicate;\n  int<lower = 0> n_id;\n  array[n_replicate, n_id] real y;\n  array[n_replicate, n_id] real y_test;\n\n  int<lower = 0> n_nonzero_chol_Q;\n  real log_det_Q;\n  array[n_id] int n_values;\n  array[n_nonzero_chol_Q] int index;\n  vector[n_nonzero_chol_Q] value;\n}\n\nparameters {\n  real<lower = 0> mu;\n  real<lower = 0> sigma;\n  real<lower = -0.5, upper = 1> xi;\n}\n\nmodel {\n  for (i in 1:n_replicate) {\n    for (j in 1:n_id) {\n      target += gev_lpdf(y[i, j] | mu, sigma, xi);\n    }\n  }\n}\n \ngenerated quantities {\n  real log_lik = 0;\n  {\n    \n    for (i in 1:n_replicate) {\n      vector[n_id] U;\n      for (j in 1:n_id) {\n        U[j] = gev_cdf(y_test[i, j] | mu, sigma, xi);\n        log_lik += gev_lpdf(y_test[i, j] | mu, sigma, xi);\n      }\n      log_lik += normal_copula_prec_chol_lpdf(U | n_values, index, value, log_det_Q);\n    }\n  }\n  \n}\n\n```\n:::\n\n\n# Results\n\n## Estimates of GEV Parameters\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/param_errors.png){.column-page}\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/param_errors_abs.png){.column-page}\n\n## Expected log predicted probability density\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/elppd.png){.column-page}\n\n### Comparing to the simple i.i.d. model\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/diff_elppd.png){.column-page}\n\n\n## Differences between AR(1) and Two-Step Model\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/diff_elppd_ar1.png){.column-page}\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/diff_elppd_by_size.png){.column-page}\n\n![](https://raw.githubusercontent.com/bgautijonsson/stan_experiments/master/Results/Figures/diff_elppd_by_size2.png){.column-page}",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/core-js-2.5.3/shim.min.js\"></script>\n<script src=\"../../site_libs/react-18.2.0/react.min.js\"></script>\n<script src=\"../../site_libs/react-18.2.0/react-dom.min.js\"></script>\n<script src=\"../../site_libs/reactwidget-1.0.0/react-tools.js\"></script>\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/reactable-0.4.4/reactable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/reactable-binding-0.4.4/reactable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}